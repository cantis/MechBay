{% extends 'base.html' %}
{% block content %}

<!-- FontAwesome CDN for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Miniatures</h2>
    <a class="btn btn-primary" href="{{ url_for('miniatures.add') }}">Add Miniature</a>
</div>

<!-- Series Filter -->
<div class="mb-3">
    <div class="btn-group" role="group" aria-label="Series filter">
        {% for s in ['All', 'A', 'B', 'C'] %}
        <a href="{{ url_for('miniatures.list_miniatures', q=query, sort=sort, direction=direction, series=s) }}"
            class="btn btn-outline-primary {% if series_filter == s %}active{% endif %}">
            {% if s == 'All' %}All Series{% else %}Series {{ s }}{% endif %}
        </a>
        {% endfor %}
    </div>
</div>

<!-- Search Form -->
<form class="row g-2 mb-3" method="get" action="{{ url_for('miniatures.list_miniatures') }}">
    <div class="col-auto">
        <input class="form-control" type="search" placeholder="Search" name="q" value="{{ query or '' }}" />
    </div>
    <input type="hidden" name="sort" value="{{ sort or '' }}" />
    <input type="hidden" name="direction" value="{{ direction or '' }}" />
    <input type="hidden" name="series" value="{{ series_filter or 'All' }}" />
    <div class="col-auto">
        <button class="btn btn-outline-secondary" type="submit">Search</button>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                {% set columns = [
                ('series', 'Series'),
                ('unique_id', 'Unique ID'),
                ('prefix', 'Prefix'),
                ('chassis', 'Chassis'),
                ('type', 'Type'),
                ('status', 'Status'),
                ('tray_id', 'Tray')
                ] %}
                {% for col, label in columns %}
                <th style="cursor:pointer">
                    <a href="{{ url_for('miniatures.list_miniatures', q=query, series=series_filter, sort=col, direction='asc' if sort != col or direction == 'desc' else 'desc') }}"
                        style="text-decoration:none; color:inherit;">
                        {{ label }}
                        {% if sort == col %}
                        {% if direction == 'asc' %}
                        <i class="fa-solid fa-arrow-up"></i>
                        {% elif direction == 'desc' %}
                        <i class="fa-solid fa-arrow-down"></i>
                        {% endif %}
                        {% endif %}
                    </a>
                    {% if sort == col %}
                    <a href="{{ url_for('miniatures.list_miniatures', q=query, series=series_filter) }}"
                        title="Clear sort">
                        <i class="fa-solid fa-xmark" style="color:#888"></i>
                    </a>
                    {% endif %}
                </th>
                {% endfor %}
                <th>Notes</th>
                <th style="width: 160px">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for m in miniatures %}
            <tr>
                <td><span class="badge bg-secondary">{{ m.series }}</span></td>
                <td>{{ m.unique_id }}</td>
                <td>{{ m.prefix }}</td>
                <td>{{ m.chassis }}</td>
                <td>{{ m.type }}</td>
                <td>{{ m.status or '' }}</td>
                <td>{{ m.tray_id or '' }}</td>
                <td>{{ m.notes or '' }}</td>
                <td>
                    <div class="btn-group">
                        <a class="btn btn-sm btn-outline-primary"
                            href="{{ url_for('miniatures.edit', id=m.id) }}">Edit</a>
                        <a class="btn btn-sm btn-outline-success" href="{{ url_for('miniatures.duplicate', id=m.id) }}"
                            title="Duplicate">
                            Copy
                        </a>
                        <form method="post" action="{{ url_for('miniatures.delete', id=m.id) }}"
                            onsubmit="return confirm('Delete this miniature?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" class="text-center text-muted">No miniatures yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="mt-3">
        <a class="btn btn-outline-success" href="{{ url_for('miniatures.export') }}">Export JSON</a>
        <a class="btn btn-outline-secondary" href="{{ url_for('miniatures.import_route') }}">Import JSON</a>
    </div>
</div>
{% endblock %}